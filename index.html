<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google One Toolkit Online - Nâng Cấp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .radio-label:has(input:checked) { background-color: #1e40af; color: white; border-color: #3b82f6; }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { 'primary': '#3b82f6', 'primary-hover': '#2563eb' } } } }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center">
            <h3 class="text-lg font-semibold mb-4">Quét để mở trên điện thoại</h3>
            <div id="qrcode-container" class="flex justify-center"></div>
            <button id="close-qr-modal" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-md">Đóng</button>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <svg class="w-10 h-10 text-primary" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Google One Toolkit Online</h1>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"></button>
        </header>

        <main class="space-y-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <label for="original-token" class="block text-lg font-semibold mb-3">1. Dán Token Gốc</label>
                <textarea id="original-token" rows="4" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:border-primary transition-colors" placeholder="Dán URL token của bạn vào đây..."></textarea>
                <div id="detected-info" class="mt-4 text-sm text-gray-500 dark:text-gray-400 h-5"></div>
            </div>

            <div id="options-panel" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md space-y-6 hidden">
                <div>
                    <h2 class="text-lg font-semibold mb-3">2. Chọn Gói Thay Thế</h2>
                    <div id="package-tabs" class="border-b border-gray-200 dark:border-gray-700 mb-4">
                        <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs"></nav>
                    </div>
                    <div id="package-content" class="space-y-3"></div>
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <label class="block text-sm font-medium mb-2">Thêm gói tùy chỉnh:</label>
                        <div class="flex space-x-2">
                            <input type="text" id="custom-package-name" class="flex-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md" placeholder="Tên danh mục (vd: MỚI)">
                            <input type="text" id="custom-package-code" class="flex-1 p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md" placeholder="Nhập mã gói tùy chỉnh">
                            <button id="add-custom-package" class="px-4 py-2 bg-primary text-white font-semibold rounded-md hover:bg-primary-hover">Thêm</button>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex items-center space-x-2 mb-3">
                        <h2 class="text-lg font-semibold">3. Chọn C%</h2>
                        <div class="relative has-tooltip">
                            <svg class="w-5 h-5 text-gray-400 cursor-pointer" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <div class="tooltip absolute bottom-full mb-2 w-64 bg-gray-700 text-white text-xs rounded py-2 px-3 z-10">
                                Tham số này có thể liên quan đến kênh phân phối, điều kiện giảm giá hoặc mã kiểm soát nội bộ.
                            </div>
                        </div>
                    </div>
                    <div id="c-percent-options" class="grid grid-cols-2 sm:grid-cols-4 gap-2"></div>
                </div>
            </div>
            
            <!-- Token Builder Section -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <details>
                    <summary class="text-lg font-semibold cursor-pointer">Công Cụ Xây Dựng Token (Nâng cao)</summary>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="builder-base-url" class="block text-sm font-medium mb-1">URL Cơ Sở:</label>
                            <input id="builder-base-url" type="text" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border rounded-md" value="https://tokenized.play.google.com/eacquire/multiline?">
                        </div>
                        <div>
                            <label for="builder-package-code" class="block text-sm font-medium mb-1">Mã Gói (vd: g1.2tb.ai):</label>
                            <input id="builder-package-code" type="text" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border rounded-md">
                        </div>
                        <div>
                            <label for="builder-ear" class="block text-sm font-medium mb-1">Tham số `ear` (đã mã hóa URL):</label>
                            <textarea id="builder-ear" rows="3" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border rounded-md" placeholder="Dán toàn bộ giá trị của tham số 'ear' vào đây"></textarea>
                        </div>
                         <div>
                            <label for="builder-other-params" class="block text-sm font-medium mb-1">Các tham số khác (vd: &authuser=0&id=...):</label>
                            <textarea id="builder-other-params" rows="2" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border rounded-md"></textarea>
                        </div>
                        <button id="build-token-button" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">Xây Dựng & Cập Nhật</button>
                    </div>
                </details>
            </div>

            <div id="output-panel" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hidden">
                 <label for="modified-token" class="block text-lg font-semibold mb-3">4. Token Đã Sửa Đổi</label>
                <textarea id="modified-token" rows="4" readonly class="w-full p-3 bg-gray-200 dark:bg-gray-900 border rounded-md cursor-not-allowed font-mono text-sm"></textarea>
                <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
                    <button id="copy-button" class="px-4 py-3 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 flex items-center justify-center space-x-2"></button>
                    <button id="open-link-button" class="px-4 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 flex items-center justify-center space-x-2"></button>
                    <button id="qr-code-button" class="px-4 py-3 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700 flex items-center justify-center space-x-2"></button>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
            <p>Phát triển dựa trên Google One Toolkit. Giao diện được tạo bởi Gemini.</p>
        </footer>
    </div>

    <script>
        // Self-executing function to encapsulate scope
        (() => {
            // --- DOM Elements ---
            const originalTokenInput = document.getElementById('original-token');
            const detectedInfo = document.getElementById('detected-info');
            const optionsPanel = document.getElementById('options-panel');
            const outputPanel = document.getElementById('output-panel');
            const packageTabs = document.getElementById('package-tabs').querySelector('nav');
            const packageContent = document.getElementById('package-content');
            const cPercentOptions = document.getElementById('c-percent-options');
            const modifiedTokenTextarea = document.getElementById('modified-token');
            const copyButton = document.getElementById('copy-button');
            const openLinkButton = document.getElementById('open-link-button');
            const qrCodeButton = document.getElementById('qr-code-button');
            const themeToggleButton = document.getElementById('theme-toggle');
            const customPackageNameInput = document.getElementById('custom-package-name');
            const customPackageCodeInput = document.getElementById('custom-package-code');
            const addCustomPackageButton = document.getElementById('add-custom-package');
            const qrModal = document.getElementById('qr-modal');
            const qrcodeContainer = document.getElementById('qrcode-container');
            const closeQrModalButton = document.getElementById('close-qr-modal');
            // Token Builder Elements
            const builderBaseUrl = document.getElementById('builder-base-url');
            const builderPackageCode = document.getElementById('builder-package-code');
            const builderEar = document.getElementById('builder-ear');
            const builderOtherParams = document.getElementById('builder-other-params');
            const buildTokenButton = document.getElementById('build-token-button');


            // --- Constants and State ---
            const TOKEN_URL_PREFIX = "https://tokenized.play.google.com/eacquire/";
            const TOKEN_PACKAGE_REGEX = /g1\.([^&%"'#?]+)/;
            const C_PERCENT_REGEX = /C(.)%/g;

            let state = {
                originalToken: '',
                detectedPackage: null,
                detectedCPercent: null,
                selectedPackage: 'Không thay đổi',
                selectedCPercent: 'C0%',
                packages: {
                    "THÁNG": ["Không thay đổi", "100gb", "200gb", "2tb", "2tb.ai", "5tb", "10tb", "20tb", "30tb", "ai.pro.3months_ip_50p"],
                    "NĂM": ["100gb.annual", "200gb.annual", "2tb.annual", "5tb.annual"],
                    "100GB": ["100gb.1month_eft", "100gb.2months_eft", "100gb.3months_eft", "100gb.9months_eft", "100gb.1year_eft", "100gb.annual.1month_eft", "100gb.annual.3months_eft", "100gb.annual.1year_eft"],
                    "200GB": ["200gb.1month_eft", "200gb.3months_eft", "200gb.1year_eft", "200gb.annual.1month_eft", "200gb.annual.3months_eft"],
                    "2TB": ["2tb.ai.1month_eft", "2tb.ai.2months_eft", "2tb.1month_eft", "2tb.3months_eft", "2tb.6months_eft", "2tb.annual.1month_eft", "2tb.annual.3months_eft"]
                },
                cPercentValues: ["C0%", "C1%", "C5%", "C6%"],
                activeTab: "THÁNG"
            };
            
            // --- Icons ---
            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg><span>Sao Chép</span>`;
            openLinkButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg><span>Mở Link</span>`;
            qrCodeButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg><span>Mã QR</span>`.replace('M12 4v16m8-8H4', 'M4 4h16v16H4z M8 12h8 M12 8v8');


            // --- Utility Functions ---
            const showToast = (message, type = 'info') => {
                const toast = document.createElement('div');
                const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
                toast.className = `px-4 py-3 rounded-md text-white ${colors[type]} shadow-lg transform transition-all duration-300 translate-x-full opacity-0`;
                toast.textContent = message;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.classList.remove('translate-x-full', 'opacity-0'), 10);
                setTimeout(() => {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            };

            const copyToClipboard = (text) => {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text)
                        .then(() => showToast('Đã sao chép vào clipboard!', 'success'))
                        .catch(() => showToast('Lỗi khi sao chép.', 'error'));
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "absolute";
                    textArea.style.left = "-999999px";
                    document.body.prepend(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast('Đã sao chép vào clipboard!', 'success');
                    } catch (err) {
                        showToast('Lỗi khi sao chép.', 'error');
                    } finally {
                        textArea.remove();
                    }
                }
            };

            // --- Token Logic ---
            const tokenUtils = {
                validateToken: (tokenString) => tokenString && tokenString.startsWith(TOKEN_URL_PREFIX) && tokenString.includes("g1."),
                extractParam: (url, param) => {
                    const urlObj = new URL(url);
                    return urlObj.searchParams.get(param);
                },
                extractPackageCode: (tokenString) => {
                    const match = tokenString.match(TOKEN_PACKAGE_REGEX);
                    return match ? match[1] : null;
                },
                extractCPercentCode: (tokenString) => {
                    try {
                        const earDecoded = decodeURIComponent(tokenUtils.extractParam(tokenString, 'ear') || '');
                        const match = earDecoded.match(C_PERCENT_REGEX);
                        return match ? match[0] : null;
                    } catch {
                        return null;
                    }
                },
                processToken: (originalToken, newPackageCode, newCPercent) => {
                    if (!tokenUtils.validateToken(originalToken)) return null;
                    let modifiedToken = originalToken;
                    const currentPackageCode = tokenUtils.extractPackageCode(originalToken);
                    const currentCPercent = tokenUtils.extractCPercentCode(originalToken);

                    if (newPackageCode && newPackageCode !== 'Không thay đổi' && currentPackageCode) {
                        modifiedToken = modifiedToken.replace(`g1.${currentPackageCode}`, `g1.${newPackageCode}`);
                    }
                    if (newCPercent && currentCPercent) {
                        try {
                            const earParam = tokenUtils.extractParam(modifiedToken, 'ear');
                            if (earParam) {
                                const decodedEar = decodeURIComponent(earParam);
                                const newDecodedEar = decodedEar.replace(currentCPercent, newCPercent);
                                const newEncodedEar = encodeURIComponent(newDecodedEar);
                                modifiedToken = modifiedToken.replace(earParam, newEncodedEar);
                            }
                        } catch { return null; }
                    }
                    return modifiedToken;
                }
            };
            
            // --- UI Rendering ---
            const render = () => {
                packageTabs.innerHTML = '';
                Object.keys(state.packages).forEach(tabName => {
                    const tabButton = document.createElement('button');
                    tabButton.className = `tab-button py-2 px-4 font-medium text-sm rounded-t-lg border-b-2 border-transparent transition-colors whitespace-nowrap ${state.activeTab === tabName ? 'active' : ''}`;
                    tabButton.textContent = tabName;
                    tabButton.onclick = () => { state.activeTab = tabName; render(); };
                    packageTabs.appendChild(tabButton);
                });

                const activePackages = state.packages[state.activeTab] || [];
                packageContent.innerHTML = `<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">${
                    activePackages.map(pkg => {
                        const id = `pkg-${pkg.replace(/[^a-zA-Z0-9]/g, '-')}`;
                        return `<label for="${id}" class="radio-label block p-3 border border-gray-300 dark:border-gray-600 rounded-md text-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-sm">
                                    <input type="radio" name="package" id="${id}" value="${pkg}" class="sr-only" ${state.selectedPackage === pkg ? 'checked' : ''}>
                                    ${pkg}
                                </label>`;
                    }).join('')
                }</div>`;

                cPercentOptions.innerHTML = state.cPercentValues.map(val => {
                    const id = `c-percent-${val.replace('%', '')}`;
                    return `<label for="${id}" class="radio-label block p-3 border border-gray-300 dark:border-gray-600 rounded-md text-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <input type="radio" name="c-percent" id="${id}" value="${val}" class="sr-only" ${state.selectedCPercent === val ? 'checked' : ''}>
                                ${val}
                            </label>`;
                }).join('');
                
                // Add event listeners after rendering
                document.querySelectorAll('input[name="package"]').forEach(radio => radio.onchange = (e) => { state.selectedPackage = e.target.value; updateModifiedToken(); render(); });
                document.querySelectorAll('input[name="c-percent"]').forEach(radio => radio.onchange = (e) => { state.selectedCPercent = e.target.value; updateModifiedToken(); render(); });
            };

            const updateModifiedToken = () => {
                if (!state.originalToken) return;
                const newToken = tokenUtils.processToken(state.originalToken, state.selectedPackage, state.selectedCPercent);
                modifiedTokenTextarea.value = newToken || 'Lỗi: Không thể xử lý token.';
            };
            
            const handleTokenInput = () => {
                const token = originalTokenInput.value.trim();
                if (tokenUtils.validateToken(token)) {
                    state.originalToken = token;
                    state.detectedPackage = tokenUtils.extractPackageCode(token);
                    state.detectedCPercent = tokenUtils.extractCPercentCode(token);
                    
                    detectedInfo.textContent = `Phát hiện: Gói ${state.detectedPackage || 'N/A'} / ${state.detectedCPercent || 'N/A'}`;
                    optionsPanel.classList.remove('hidden');
                    outputPanel.classList.remove('hidden');
                    
                    autoAddNewPackage(state.detectedPackage);
                    
                    updateModifiedToken();
                    render();
                } else {
                    state.originalToken = '';
                    detectedInfo.textContent = token ? 'Token không hợp lệ.' : '';
                    optionsPanel.classList.add('hidden');
                    outputPanel.classList.add('hidden');
                    modifiedTokenTextarea.value = '';
                }
            };
            
            const autoAddNewPackage = (pkgCode) => {
                if (!pkgCode) return;
                const isExisting = Object.values(state.packages).flat().includes(pkgCode);
                if (!isExisting) {
                    const category = 'TỰ ĐỘNG';
                    if (!state.packages[category]) state.packages[category] = [];
                    state.packages[category].push(pkgCode);
                    savePackagesToStorage();
                    showToast(`Đã tự động thêm gói mới "${pkgCode}" vào danh mục "${category}"`, 'success');
                    render();
                }
            };
            
            const addCustomPackage = () => {
                const category = customPackageNameInput.value.trim().toUpperCase() || 'TÙY CHỈNH';
                const code = customPackageCodeInput.value.trim();
                if (!code) { showToast('Mã gói tùy chỉnh không được để trống.', 'error'); return; }
                if (!state.packages[category]) state.packages[category] = [];
                if (state.packages[category].includes(code)) { showToast(`Gói "${code}" đã tồn tại.`, 'info'); return; }

                state.packages[category].push(code);
                savePackagesToStorage();
                showToast(`Đã thêm gói "${code}" vào danh mục "${category}"`, 'success');
                customPackageNameInput.value = '';
                customPackageCodeInput.value = '';
                state.activeTab = category;
                render();
            };

            const savePackagesToStorage = () => {
                const customPackages = {};
                Object.keys(state.packages).forEach(cat => {
                    if (!['THÁNG', 'NĂM', '100GB', '200GB', '2TB'].includes(cat)) {
                       customPackages[cat] = state.packages[cat];
                    }
                });
                localStorage.setItem('customGoogleOnePackages', JSON.stringify(customPackages));
            };
            
            const loadPackagesFromStorage = () => {
                const customPackages = JSON.parse(localStorage.getItem('customGoogleOnePackages') || '{}');
                state.packages = { ...state.packages, ...customPackages };
            };

            const updateTheme = () => {
                const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                document.documentElement.classList.toggle('dark', isDark);
                themeToggleButton.innerHTML = isDark ? sunIcon : moonIcon;
            };

            // --- Event Listeners ---
            originalTokenInput.addEventListener('input', handleTokenInput);
            addCustomPackageButton.addEventListener('click', addCustomPackage);
            copyButton.addEventListener('click', () => copyToClipboard(modifiedTokenTextarea.value));
            openLinkButton.addEventListener('click', () => {
                const url = modifiedTokenTextarea.value;
                if (url && url.startsWith('http')) window.open(url, '_blank');
                else showToast('URL không hợp lệ để mở.', 'error');
            });
            themeToggleButton.addEventListener('click', () => {
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                updateTheme();
            });
            qrCodeButton.addEventListener('click', () => {
                const url = modifiedTokenTextarea.value;
                if(url) {
                    qrcodeContainer.innerHTML = '';
                    new QRCode(qrcodeContainer, { text: url, width: 256, height: 256 });
                    qrModal.classList.remove('hidden');
                } else {
                    showToast('Không có token để tạo mã QR.', 'error');
                }
            });
            closeQrModalButton.addEventListener('click', () => qrModal.classList.add('hidden'));
            buildTokenButton.addEventListener('click', () => {
                let finalUrl = builderBaseUrl.value;
                const earValue = builderEar.value;
                const otherParams = builderOtherParams.value;

                if (earValue) {
                    // Replace package code inside the ear if it exists
                    const decodedEar = decodeURIComponent(earValue);
                    const currentPkg = tokenUtils.extractPackageCode(decodedEar);
                    if (currentPkg && builderPackageCode.value) {
                         const newDecodedEar = decodedEar.replace(`g1.${currentPkg}`, `g1.${builderPackageCode.value}`);
                         finalUrl += `ear=${encodeURIComponent(newDecodedEar)}`;
                    } else {
                         finalUrl += `ear=${earValue}`;
                    }
                }
                
                if (otherParams) {
                    finalUrl += (finalUrl.endsWith('?') ? '' : '&') + otherParams.replace(/^&/, '');
                }
                
                originalTokenInput.value = finalUrl;
                handleTokenInput();
                showToast('Đã xây dựng và cập nhật token!', 'success');
            });


            // --- Initialization ---
            loadPackagesFromStorage();
            render();
            updateTheme();
        })();
    </script>
</body>
</html>
